# üå± AGRISMART - PROCHAINES √âTAPES DE D√âVELOPPEMENT

## üìã PLAN DE D√âVELOPPEMENT - SYST√àME MULTI-UTILISATEURS

### ‚è∞ **TIMELINE**: D√©marrage dans 8 heures
### üéØ **OBJECTIF**: Transformer AgriSmart en plateforme multi-utilisateurs avec gestion d'exploitations

---

## üîê A. SYST√àME D'AUTHENTIFICATION ET MULTI-UTILISATEURS

### A.1 - Nouveaux Mod√®les Django

#### üìÅ **Fichier**: `capteurs/models.py`

```python
# NOUVEAUX MOD√àLES √Ä AJOUTER

class Exploitation(models.Model):
    """Repr√©sente une exploitation agricole (serre/champ)"""
    nom = models.CharField(max_length=100)
    description = models.TextField(blank=True)
    localisation = models.CharField(max_length=200)
    superficie = models.FloatField(help_text="Superficie en hectares")
    type_culture = models.CharField(max_length=50)
    proprietaire = models.ForeignKey(User, on_delete=models.CASCADE)
    date_creation = models.DateTimeField(auto_now_add=True)
    active = models.BooleanField(default=True)

class AgriSensor(models.Model):
    """Capteur IoT li√© √† une exploitation"""
    nom = models.CharField(max_length=50)
    code_unique = models.CharField(max_length=20, unique=True)
    exploitation = models.ForeignKey(Exploitation, on_delete=models.CASCADE)
    position_x = models.FloatField(default=0)
    position_y = models.FloatField(default=0)
    actif = models.BooleanField(default=True)
    derniere_connexion = models.DateTimeField(null=True, blank=True)

class UserProfile(models.Model):
    """Profil utilisateur √©tendu"""
    user = models.OneToOneField(User, on_delete=models.CASCADE)
    telephone = models.CharField(max_length=20, blank=True)
    region = models.CharField(max_length=50)
    experience_agricole = models.IntegerField(default=0)
    type_agriculteur = models.CharField(max_length=30)
    
# MODIFIER LE MOD√àLE EXISTANT
class Mesure(models.Model):
    # ... champs existants ...
    
    # NOUVEAU CHAMP
    agri_sensor = models.ForeignKey(AgriSensor, on_delete=models.CASCADE)
    exploitation = models.ForeignKey(Exploitation, on_delete=models.CASCADE)
```

#### üîß **Actions √† r√©aliser**:
1. **Cr√©er les migrations**: `python manage.py makemigrations`
2. **Appliquer les migrations**: `python manage.py migrate`
3. **Cr√©er script de migration des donn√©es existantes**
4. **Tester l'int√©grit√© des donn√©es**

### A.2 - Syst√®me d'Authentification

#### üìÅ **Fichiers √† cr√©er**:

**`capteurs/forms.py`**
```python
# Formulaires d'inscription et login
class UserRegistrationForm(UserCreationForm)
class ExploitationForm(forms.ModelForm)
class AgriSensorForm(forms.ModelForm)
```

**`capteurs/views_auth.py`**
```python
# Vues d'authentification
def register_view(request)
def login_view(request)
def logout_view(request)
def onboarding_view(request)
def profile_view(request)
```

**`templates/auth/`**
```
‚îú‚îÄ‚îÄ login.html
‚îú‚îÄ‚îÄ register.html
‚îú‚îÄ‚îÄ onboarding.html
‚îî‚îÄ‚îÄ profile.html
```

#### üîß **Actions √† r√©aliser**:
1. **Cr√©er les formulaires d'inscription/login**
2. **D√©velopper les vues d'authentification**
3. **Cr√©er les templates d'interface**
4. **Configurer les URLs d'authentification**
5. **Tester le flux complet d'inscription**

### A.3 - Middleware d'Isolation des Donn√©es

#### üìÅ **Fichier**: `capteurs/middleware.py`

```python
class DataIsolationMiddleware:
    """Middleware pour isoler les donn√©es par utilisateur"""
    
    def __init__(self, get_response):
        self.get_response = get_response
    
    def __call__(self, request):
        # Ajouter le filtre utilisateur automatiquement
        if request.user.is_authenticated:
            request.user_exploitations = Exploitation.objects.filter(
                proprietaire=request.user
            )
        
        response = self.get_response(request)
        return response
```

#### üîß **Actions √† r√©aliser**:
1. **Cr√©er le middleware d'isolation**
2. **Configurer dans `settings.py`**
3. **Modifier toutes les vues pour filtrer par utilisateur**
4. **Tester l'isolation des donn√©es**

### A.4 - Interface d'Onboarding

#### üìã **√âtapes d'onboarding**:
1. **Informations personnelles**
2. **Cr√©ation de la premi√®re exploitation**
3. **Configuration du premier capteur**
4. **Guide d'installation**
5. **Test de connexion**

#### üîß **Actions √† r√©aliser**:
1. **Cr√©er l'interface step-by-step**
2. **D√©velopper la logique de progression**
3. **Int√©grer les guides d'installation**
4. **Tester le parcours complet**

### A.5 - Dashboard Multi-Exploitation

#### üìä **Fonctionnalit√©s**:
- **S√©lecteur d'exploitation**
- **Vue d'ensemble multi-capteurs**
- **Comparaison entre exploitations**
- **Alertes personnalis√©es**

#### üîß **Actions √† r√©aliser**:
1. **Modifier le dashboard existant**
2. **Ajouter le s√©lecteur d'exploitation**
3. **Cr√©er les vues de comparaison**
4. **Adapter les graphiques**

### A.6 - API S√©curis√©e avec Tokens

#### üìÅ **Fichier**: `capteurs/api.py`

```python
from rest_framework.authtoken.models import Token
from rest_framework.decorators import api_view, permission_classes
from rest_framework.permissions import IsAuthenticated

@api_view(['POST'])
@permission_classes([IsAuthenticated])
def receive_sensor_data(request):
    # API s√©curis√©e pour recevoir les donn√©es ESP32
    pass
```

#### üîß **Actions √† r√©aliser**:
1. **Installer Django REST Framework**
2. **Cr√©er les endpoints s√©curis√©s**
3. **G√©n√©rer les tokens d'authentification**
4. **Tester l'API avec tokens**

---

## üì° B. ADAPTATION ESP32 - MODE SoftAP

### B.1 - Configuration SoftAP

#### üìÅ **Fichier**: `agrisensor_multi_user.ino`

```cpp
// NOUVELLES FONCTIONNALIT√âS √Ä AJOUTER

// 1. Configuration multi-utilisateur
struct UserConfig {
    char user_token[64];
    char exploitation_id[16];
    char sensor_id[16];
    char api_endpoint[128];
};

// 2. Interface web de configuration
void handleConfigPage() {
    String html = R"(
    <!DOCTYPE html>
    <html>
    <head>
        <title>Configuration AgriSensor</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <style>
            body { font-family: Arial; margin: 20px; }
            .form-group { margin: 15px 0; }
            input, select { width: 100%; padding: 8px; margin: 5px 0; }
            button { background: #2ecc71; color: white; padding: 10px 20px; border: none; border-radius: 5px; }
        </style>
    </head>
    <body>
        <h1>üå± Configuration AgriSensor</h1>
        <form action="/save-config" method="POST">
            <div class="form-group">
                <label>Token Utilisateur:</label>
                <input type="text" name="user_token" placeholder="Votre token d'authentification" required>
            </div>
            <div class="form-group">
                <label>ID Exploitation:</label>
                <input type="text" name="exploitation_id" placeholder="ID de votre exploitation" required>
            </div>
            <div class="form-group">
                <label>R√©seau WiFi:</label>
                <select name="wifi_ssid" id="wifi_list">
                    <option>Recherche des r√©seaux...</option>
                </select>
            </div>
            <div class="form-group">
                <label>Mot de passe WiFi:</label>
                <input type="password" name="wifi_password" placeholder="Mot de passe WiFi">
            </div>
            <button type="submit">üíæ Sauvegarder</button>
        </form>
        <script>
            // Charger la liste des r√©seaux WiFi
            fetch('/scan-wifi')
                .then(response => response.json())
                .then(networks => {
                    const select = document.getElementById('wifi_list');
                    select.innerHTML = '';
                    networks.forEach(network => {
                        const option = document.createElement('option');
                        option.value = network.ssid;
                        option.textContent = network.ssid + ' (' + network.signal + ')';
                        select.appendChild(option);
                    });
                });
        </script>
    </body>
    </html>
    )";
    
    server.send(200, "text/html", html);
}

// 3. Sauvegarde configuration utilisateur
void handleSaveConfig() {
    UserConfig config;
    strcpy(config.user_token, server.arg("user_token").c_str());
    strcpy(config.exploitation_id, server.arg("exploitation_id").c_str());
    strcpy(config.sensor_id, generateSensorId().c_str());
    
    // Sauvegarder en EEPROM
    saveUserConfig(config);
    
    // Tenter connexion WiFi
    connectToWiFi(server.arg("wifi_ssid"), server.arg("wifi_password"));
    
    server.send(200, "text/html", "<h1>‚úÖ Configuration sauvegard√©e!</h1>");
}

// 4. Envoi donn√©es avec authentification
void sendDataToServer(SensorData data) {
    if (WiFi.status() == WL_CONNECTED) {
        HTTPClient http;
        http.begin(userConfig.api_endpoint);
        
        // Headers d'authentification
        http.addHeader("Content-Type", "application/json");
        http.addHeader("Authorization", "Token " + String(userConfig.user_token));
        
        // Payload JSON
        String payload = "{";
        payload += "\"sensor_id\":\"" + String(userConfig.sensor_id) + "\",";
        payload += "\"exploitation_id\":\"" + String(userConfig.exploitation_id) + "\",";
        payload += "\"temperature\":" + String(data.temperature) + ",";
        payload += "\"humidite\":" + String(data.humidity) + ",";
        payload += "\"humidite_sol\":" + String(data.soilHumidity) + ",";
        payload += "\"qualite_air\":" + String(data.airQuality);
        payload += "}";
        
        int httpCode = http.POST(payload);
        
        if (httpCode == 200) {
            Serial.println("‚úÖ Donn√©es envoy√©es avec succ√®s");
            blinkLED(LED_SUCCESS, 3);
        } else {
            Serial.println("‚ùå Erreur envoi: " + String(httpCode));
            blinkLED(LED_ERROR, 5);
        }
        
        http.end();
    }
}
```

### B.2 - Am√©liorations Interface Web

#### üîß **Nouvelles fonctionnalit√©s**:
1. **Scan automatique des r√©seaux WiFi**
2. **Validation des tokens en temps r√©el**
3. **Test de connexion au serveur**
4. **Interface de diagnostic**
5. **Mise √† jour OTA (Over-The-Air)**

### B.3 - S√©curit√© et Authentification

#### üîí **Mesures de s√©curit√©**:
1. **Chiffrement des tokens en EEPROM**
2. **Certificats SSL pour HTTPS**
3. **Timeout de configuration (30 min)**
4. **Validation c√¥t√© serveur**

### B.4 - Gestion des Erreurs

#### üö® **Syst√®me d'alertes**:
1. **LEDs de statut**
2. **Buzzer pour erreurs critiques**
3. **√âcran LCD avec messages**
4. **Reconnexion automatique**

---

## üóÇÔ∏è C. STRUCTURE DES FICHIERS √Ä CR√âER/MODIFIER

### C.1 - Backend Django

```
monprojet/
‚îú‚îÄ‚îÄ capteurs/
‚îÇ   ‚îú‚îÄ‚îÄ models.py                 # ‚úèÔ∏è MODIFIER - Ajouter nouveaux mod√®les
‚îÇ   ‚îú‚îÄ‚îÄ views.py                  # ‚úèÔ∏è MODIFIER - Ajouter filtres utilisateur
‚îÇ   ‚îú‚îÄ‚îÄ views_auth.py             # üÜï CR√âER - Vues authentification
‚îÇ   ‚îú‚îÄ‚îÄ forms.py                  # üÜï CR√âER - Formulaires
‚îÇ   ‚îú‚îÄ‚îÄ middleware.py             # üÜï CR√âER - Isolation donn√©es
‚îÇ   ‚îú‚îÄ‚îÄ api.py                    # üÜï CR√âER - API s√©curis√©e
‚îÇ   ‚îú‚îÄ‚îÄ permissions.py            # üÜï CR√âER - Permissions granulaires
‚îÇ   ‚îî‚îÄ‚îÄ templates/
‚îÇ       ‚îú‚îÄ‚îÄ auth/                 # üÜï CR√âER - Templates auth
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ login.html
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ register.html
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ onboarding.html
‚îÇ       ‚îî‚îÄ‚îÄ capteurs/
‚îÇ           ‚îú‚îÄ‚îÄ dashboard.html    # ‚úèÔ∏è MODIFIER - Multi-exploitation
‚îÇ           ‚îú‚îÄ‚îÄ index.html        # ‚úèÔ∏è MODIFIER - S√©lecteur exploitation
‚îÇ           ‚îî‚îÄ‚îÄ profile.html      # üÜï CR√âER - Profil utilisateur
‚îú‚îÄ‚îÄ static/
‚îÇ   ‚îú‚îÄ‚îÄ css/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.css              # üÜï CR√âER - Styles authentification
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ onboarding.css        # üÜï CR√âER - Styles onboarding
‚îÇ   ‚îî‚îÄ‚îÄ js/
‚îÇ       ‚îú‚îÄ‚îÄ auth.js               # üÜï CR√âER - Scripts authentification
‚îÇ       ‚îî‚îÄ‚îÄ multi-user.js         # üÜï CR√âER - Gestion multi-utilisateur
‚îî‚îÄ‚îÄ requirements.txt              # ‚úèÔ∏è MODIFIER - Ajouter DRF
```

### C.2 - Code ESP32

```
arduino/
‚îú‚îÄ‚îÄ agrisensor_multi_user/
‚îÇ   ‚îú‚îÄ‚îÄ agrisensor_multi_user.ino # üÜï CR√âER - Version multi-utilisateur
‚îÇ   ‚îú‚îÄ‚îÄ config.h                  # üÜï CR√âER - Configuration
‚îÇ   ‚îú‚îÄ‚îÄ wifi_manager.h            # üÜï CR√âER - Gestion WiFi
‚îÇ   ‚îú‚îÄ‚îÄ user_auth.h               # üÜï CR√âER - Authentification
‚îÇ   ‚îú‚îÄ‚îÄ web_interface.h           # üÜï CR√âER - Interface web
‚îÇ   ‚îî‚îÄ‚îÄ sensor_data.h             # üÜï CR√âER - Gestion capteurs
‚îî‚îÄ‚îÄ libraries/                    # üìö Biblioth√®ques requises
    ‚îú‚îÄ‚îÄ ArduinoJson/
    ‚îú‚îÄ‚îÄ ESP32WebServer/
    ‚îî‚îÄ‚îÄ HTTPClient/
```

---

## üìù D. CHECKLIST DE D√âVELOPPEMENT

### Phase 1: Pr√©paration (1-2h)
- [ ] Analyser le code existant
- [ ] Cr√©er les branches Git appropri√©es
- [ ] Installer les d√©pendances requises
- [ ] Sauvegarder la base de donn√©es actuelle

### Phase 2: Mod√®les Django (2-3h)
- [ ] Cr√©er les nouveaux mod√®les
- [ ] G√©n√©rer et appliquer les migrations
- [ ] Cr√©er un script de migration des donn√©es
- [ ] Tester l'int√©grit√© des donn√©es

### Phase 3: Authentification (3-4h)
- [ ] D√©velopper les vues d'authentification
- [ ] Cr√©er les formulaires
- [ ] D√©velopper les templates
- [ ] Tester le flux complet

### Phase 4: Isolation des Donn√©es (2-3h)
- [ ] Cr√©er le middleware
- [ ] Modifier toutes les vues existantes
- [ ] Tester l'isolation
- [ ] Valider la s√©curit√©

### Phase 5: Interface Multi-Utilisateur (4-5h)
- [ ] Adapter le dashboard
- [ ] Cr√©er l'onboarding
- [ ] D√©velopper le profil utilisateur
- [ ] Tester l'exp√©rience utilisateur

### Phase 6: API S√©curis√©e (2-3h)
- [ ] Cr√©er les endpoints
- [ ] Impl√©menter l'authentification par token
- [ ] Tester avec Postman
- [ ] Documenter l'API

### Phase 7: Code ESP32 (4-6h)
- [ ] D√©velopper le mode SoftAP
- [ ] Cr√©er l'interface web
- [ ] Impl√©menter l'authentification
- [ ] Tester la configuration

### Phase 8: Tests et D√©bogage (2-3h)
- [ ] Tests unitaires
- [ ] Tests d'int√©gration
- [ ] Tests de s√©curit√©
- [ ] Optimisation des performances

---

## üöÄ E. D√âMARRAGE DANS 8 HEURES

### E.1 - Pr√©paration Imm√©diate

#### üîß **Commandes √† ex√©cuter**:
```bash
# 1. Cr√©er une branche pour le d√©veloppement
git checkout -b feature/multi-user-system

# 2. Installer les d√©pendances
pip install djangorestframework
pip install django-cors-headers

# 3. Sauvegarder la DB actuelle
python manage.py dumpdata > backup_before_multiuser.json

# 4. Cr√©er les dossiers n√©cessaires
mkdir -p capteurs/templates/auth
mkdir -p static/css/auth
mkdir -p static/js/auth
```

#### üìã **Fichiers √† pr√©parer**:
1. **Plan de migration des donn√©es**
2. **Scripts de test**
3. **Documentation API**
4. **Guide d'installation ESP32**

### E.2 - Ordre d'Ex√©cution

1. **üîê Authentification** (Priorit√© 1)
2. **üìä Isolation des donn√©es** (Priorit√© 1)
3. **üåê Interface multi-utilisateur** (Priorit√© 2)
4. **üì° Code ESP32** (Priorit√© 2)
5. **üîí S√©curit√© et tests** (Priorit√© 3)

### E.3 - Points d'Attention

‚ö†Ô∏è **Critiques**:
- **Migration des donn√©es existantes sans perte**
- **R√©trocompatibilit√© avec les capteurs actuels**
- **S√©curit√© des tokens et authentification**
- **Performance avec multiple utilisateurs**

‚úÖ **Validation**:
- **Tests sur chaque √©tape**
- **Sauvegarde avant modifications**
- **Documentation des changements**
- **Plan de rollback en cas d'erreur**

---

## üìû SUPPORT ET RESSOURCES

### üìö Documentation
- **Django User Authentication**: https://docs.djangoproject.com/en/4.2/topics/auth/
- **Django REST Framework**: https://www.django-rest-framework.org/
- **ESP32 WiFi Manager**: https://github.com/tzapu/WiFiManager

### üõ†Ô∏è Outils Recommand√©s
- **Postman**: Test des APIs
- **DB Browser**: Visualisation SQLite
- **Arduino IDE**: D√©veloppement ESP32
- **Git**: Gestion des versions

---

## üéØ OBJECTIFS FINAUX

√Ä la fin de ce d√©veloppement, AgriSmart aura:

‚úÖ **Syst√®me multi-utilisateurs complet**
‚úÖ **Authentification s√©curis√©e**
‚úÖ **Isolation des donn√©es par exploitation**
‚úÖ **Interface d'onboarding intuitive**
‚úÖ **API s√©curis√©e pour ESP32**
‚úÖ **Configuration ESP32 simplifi√©e**
‚úÖ **Dashboard multi-exploitation**
‚úÖ **Gestion des permissions granulaires**

---

**üöÄ PR√äT √Ä D√âMARRER DANS 8 HEURES !**

*D√©velopp√© par D√©buze David - AgriSmart Team*
*R√©publique D√©mocratique du Congo* 